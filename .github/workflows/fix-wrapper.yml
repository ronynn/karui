name: Fix Gradle Wrapper

on:
  push:
    branches:
      - main  
  workflow_dispatch:  

jobs:
  fix-wrapper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Gradle Distribution
        run: |
          GRADLE_VERSION="8.4"
          JAR_URL="https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          CHECKSUM_URL="https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip.sha256"

          # Download Gradle distribution & checksum
          wget -q "$JAR_URL" -O gradle.zip
          wget -q "$CHECKSUM_URL" -O gradle.zip.sha256

      - name: Verify ZIP Checksum (Before Extraction)
        run: sha256sum -c gradle.zip.sha256 || (echo "ZIP Checksum mismatch!" && exit 1)

      - name: List ZIP Contents (Debugging)
        run: unzip -l gradle.zip

      - name: Extract and Rename Gradle Wrapper JAR
        run: |
          # Extract the correct JAR file
          unzip -j gradle.zip "gradle-8.4/lib/plugins/gradle-wrapper-8.4.jar" -d gradle/wrapper/
          
          # Rename it to match expected filename
          mv gradle/wrapper/gradle-wrapper-8.4.jar gradle/wrapper/gradle-wrapper.jar

          # Cleanup
          rm gradle.zip gradle.zip.sha256

      - name: Get Official Checksum for JAR
        run: |
          # Compute checksum for the extracted file
          JAR_CHECKSUM=$(sha256sum gradle/wrapper/gradle-wrapper.jar | awk '{ print $1 }')

          # Print checksum for debugging
          echo "Extracted JAR Checksum: $JAR_CHECKSUM"

      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add gradle/wrapper/gradle-wrapper.jar
          git commit -m "Fix: Replace corrupted Gradle Wrapper with verified version" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  

      - name: Trigger Build Workflow
        run: gh workflow run build.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
